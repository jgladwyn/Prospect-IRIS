#!/usr/bin/env groovy

pipeline {
    agent any

    tools { 
        maven 'Maven 3.3.9' 
        jdk 'JDK 1.8' 
        git 'GIT'
    }
    
    environment { 
        MAVEN_LOCAL_REPO = 'C:/DS/DesignStudioT24-201702.5/t24-binaries'
        T24_HOME_PACKAGE = 'C:/UTP/Daily_UTP_minimal/Temenos/t24home/default/package'
        T24_HOME = 'C:/UTP/Daily_UTP_minimal/Temenos/t24home/default'
        TAFJ_HOME = 'C:/UTP/Daily_UTP_minimal/Temenos/TAFJ'
        JAVA_HOME = 'C:/UTP/Daily_UTP_minimal/Temenos/java/jdk-7u76-windows-x64'
        
        PACKAGE_PREFIX = 'Prospect'
        
    }

    stages {
        stage('Deploy DS Package to Cloud test env') {
            steps {
                echo 'Deploying....'    
                
                dir('remote-cloud-t24') {
                        git url: 'file:/C:/workspace/DS-Packager/prospect-iris1-201702/cloud-david-t24'
                }
                
                // bat 'mkdir remotegit'
                echo "${env.WORKSPACE}"
                
                // git url: "C:/workspace/DS-Packager/prospect-iris1-201702/cloud-david-t24"
                // git clone "C:/workspace/DS-Packager/prospect-iris1-201702/cloud-david-t24"                 

                
                echo 'Deploying....'

                echo 'Try to copy files ....'

                bat "xcopy %PACKAGE_PREFIX%-packager\\target\\*.jar remote-cloud-t24\\packages /Y"

                echo 'Copy files done....'

                withEnv(["PATH+GIT=C:\\apps\\git\\bin"]) {
                    echo 'Git commands....'
                    // bat "git --git-dir=remote-cloud-t24/.git --work-tree=remote-cloud-t24 add *.jar"
                    
                    // bat "git --git-dir=remote-cloud-t24/.git --work-tree=remote-cloud-t24 commit -m\"Sample commit\""
                    
                    // bat "git --git-dir=remote-cloud-t24/.git --work-tree=remote-cloud-t24 push origin master"
                }                

            }
        }    
    
        stage('Clean') {
            steps {
               echo 'Cleaning..'
               
               bat 'mvn -B -o -f %PACKAGE_PREFIX%-packager/module/pom.xml -Dmaven.repo.local=%MAVEN_LOCAL_REPO% -Dds.ignoreValidationErrors=true clean'
               
               bat 'mvn -B -o -f %PACKAGE_PREFIX%-iris-parent/pom.xml -Dmaven.repo.local=%MAVEN_LOCAL_REPO% clean'
            }
        } 
           
        stage('Build DS Package') {
            steps {
               echo 'Building..'
               
               bat 'mvn -B -o -f %PACKAGE_PREFIX%-packager/module/pom.xml -Dmaven.repo.local=%MAVEN_LOCAL_REPO% -Dds.ignoreValidationErrors=true install'
               
               step([$class: 'ArtifactArchiver', artifacts: '**/target/*.jar', fingerprint: true])
            }
        }
        
        stage('Unit tests') {
            steps {
                echo 'Testing..'
            }
        }

        stage('Build IRIS war') {
            steps {
               echo 'Building..'
               
               bat 'mvn -B -o -f %PACKAGE_PREFIX%-iris-parent/pom.xml -Dmaven.repo.local=%MAVEN_LOCAL_REPO% install'
               
               step([$class: 'ArtifactArchiver', artifacts: '**/target/*.war', fingerprint: true])
            }
        }

        

        
        stage('Integration test') {
            steps {
                echo 'Testing on server..'
            }
        }
        
    }
}